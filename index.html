<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Labz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #000;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            padding: 2rem;
        }

        /* Contenedores de todas las secciones, ahora con la misma configuración */
        .main-container, .form-container {
            max-width: 700px;
            width: 100%;
            padding: 2rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: left;
            /* Permite el scroll solo en los contenedores de formulario/tienda si son demasiado largos */
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* La sección principal es un caso especial y el texto está centrado */
        .main-container {
            text-align: center;
        }

        .active-section {
            opacity: 1;
            pointer-events: auto;
        }

        .cipher-text {
            font-size: 2.5rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: block;
            text-shadow: 0 0 2px #ccc, 0 0 4px #ccc, 0 0 6px #ccc;
        }

        .options-text {
            font-size: 1.5rem;
            margin-top: 1rem;
            font-weight: 400;
            display: block;
            opacity: 0;
            transition: opacity 0.7s ease-in-out;
        }

        .leap-text {
            font-size: 1.25rem;
            margin-top: 0.5rem;
            font-style: italic;
            opacity: 0.8;
            font-weight: 300;
            display: block;
            opacity: 0;
            transition: opacity 0.7s ease-in-out;
        }

        .buttons-container {
            margin-top: 2rem;
        }

        .btn {
            background-color: #ff8c00;
            border: 2px solid #ff8c00;
            color: #fff;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            text-transform: uppercase;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s, box-shadow 0.3s;
            margin: 0 0.5rem;
            cursor: pointer;
        }

        .btn:hover {
            background-color: #e67e00;
            border-color: #e67e00;
            color: #fff;
            box-shadow: 0 0 15px rgba(255, 140, 0, 0.6);
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            background-color: #111;
            border: 1px solid #333;
            color: #fff;
            border-radius: 0.5rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #ff8c00;
        }

        .form-label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .shipping-cost {
            font-size: 1.25rem;
            font-weight: bold;
            text-align: center;
            margin-top: 1rem;
            color: #ff8c00;
        }
        
        .product-section-title {
            text-align: center;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .product-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .product-item {
            background: none;
            border: 2px solid transparent;
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }

        .product-item:hover {
            background-color: #111;
            border-color: #ff8c00;
        }
        
        .product-item.selected {
            background-color: #111;
            border-color: #ff8c00;
            box-shadow: 0 0 10px #ff8c00;
        }


        .product-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .product-icon {
            font-size: 2rem;
        }
        
        .product-details {
            text-align: left;
        }

        .product-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .product-price {
            color: #ff8c00;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quantity-btn {
            background-color: #333;
            border: 1px solid #555;
            color: #fff;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            user-select: none;
        }

        .quantity-btn:hover {
            background-color: #ff8c00;
            border-color: #ff8c00;
        }

        .quantity-display {
            width: 40px;
            text-align: center;
        }

        .remove-btn {
            font-size: 1.5rem;
            color: #fff;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
            margin-left: 1rem;
        }

        .remove-btn:hover {
            color: #ff8c00;
        }


        .summary-container {
            margin-top: 2rem;
            text-align: left;
            padding: 1rem;
            border-top: 1px solid #333;
        }
        
        .summary-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .summary-total {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 1rem;
            text-align: right;
            color: #ff8c00;
        }
        
        .message-box {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #22c55e;
            color: #fff;
            padding: 1rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1000;
        }
    </style>
</head>
<body>

    <!-- Main Content -->
    <div id="main-container" class="main-container active-section">
        <span id="cipher-text" class="cipher-text"></span>
        <span id="options-text" class="options-text"></span>
        <span id="leap-text" class="leap-text"></span>
        <div id="buttons-container" class="buttons-container hidden flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4">
            <button class="btn" id="patrocinio-btn" type="button">Patrocinio</button>
            <button class="btn" id="tienda-btn" type="button">Comprar productos</button>
        </div>
    </div>

    <!-- Patrocinio & Tienda Form Combined -->
    <div id="patrocinio-container" class="form-container">
        <h2 id="form-title" class="text-2xl font-bold mb-4">Formulario de Patrocinio</h2>
        <form id="patrocinio-form">
            <label for="nombre" class="form-label">Nombre:</label>
            <input type="text" id="nombre" name="nombre" class="form-input" required placeholder="Tu nombre completo">

            <label for="celular" class="form-label">Número de celular:</label>
            <input type="tel" id="celular" name="celular" class="form-input" required placeholder="Ej. 55 1234 5678">

            <label for="email" class="form-label">Correo electrónico:</label>
            <input type="email" id="email" name="email" class="form-input" required placeholder="tu-correo@ejemplo.com">
            
            <label for="direccion" class="form-label">Dirección:</label>
            <input type="text" id="direccion" name="direccion" class="form-input" required placeholder="Calle, número exterior e interior">

            <label for="colonia" class="form-label">Colonia:</label>
            <input type="text" id="colonia" name="colonia" class="form-input" required placeholder="Colonia">

            <label for="ciudad" class="form-label">Ciudad:</label>
            <input type="text" id="ciudad" name="ciudad" class="form-input" required placeholder="Ciudad">

            <label for="estado" class="form-label">Estado:</label>
            <input type="text" id="estado" name="estado" class="form-input" list="estados-mexico" required placeholder="Selecciona o escribe tu estado">
            <datalist id="estados-mexico"></datalist>

            <label for="cp" class="form-label">Código Postal:</label>
            <input type="text" id="cp" name="cp" class="form-input" required placeholder="Ej. 12345">

            <label for="referencia" class="form-label">Referencia:</label>
            <textarea id="referencia" name="referencia" class="form-input" rows="3" required placeholder="Referencia para la entrega"></textarea>

            <!-- Products section moved inside the form -->
            <div id="products-section">
                <h3 class="product-section-title" id="products-title">Nuestros Productos</h3>
                <div class="product-list">
                    <div class="product-item" data-product-id="1" data-price="450" data-name="Whey Protein 17 oz">
                        <div class="product-info">
                            <div class="product-icon">💪</div>
                            <div class="product-details">
                                <div class="product-title">Whey Protein 17 oz</div>
                                <div class="product-price">$450 MXN</div>
                            </div>
                        </div>
                        <div class="quantity-control">
                            <button class="quantity-btn minus-btn" type="button">-</button>
                            <span class="quantity-display">0</span>
                            <button class="quantity-btn plus-btn" type="button">+</button>
                        </div>
                    </div>
                    <div class="product-item" data-product-id="2" data-price="820" data-name="Whey Protein 4 LBS">
                        <div class="product-info">
                            <div class="product-icon">💪</div>
                            <div class="product-details">
                                <div class="product-title">Whey Protein 4 LBS</div>
                                <div class="product-price">$820 MXN</div>
                            </div>
                        </div>
                        <div class="quantity-control">
                            <button class="quantity-btn minus-btn" type="button">-</button>
                            <span class="quantity-display">0</span>
                            <button class="quantity-btn plus-btn" type="button">+</button>
                        </div>
                    </div>
                    <div class="product-item" data-product-id="3" data-price="450" data-name="Creatina 300g">
                        <div class="product-info">
                            <div class="product-icon">💊</div>
                            <div class="product-details">
                                <div class="product-title">Creatina 300g</div>
                                <div class="product-price">$450 MXN</div>
                            </div>
                        </div>
                        <div class="quantity-control">
                            <button class="quantity-btn minus-btn" type="button">-</button>
                            <span class="quantity-display">0</span>
                            <button class="quantity-btn plus-btn" type="button">+</button>
                        </div>
                    </div>
                    <div class="product-item" data-product-id="4" data-price="450" data-name="BCAA 300g">
                        <div class="product-info">
                            <div class="product-icon">💊</div>
                            <div class="product-details">
                                <div class="product-title">BCAA 300g</div>
                                <div class="product-price">$450 MXN</div>
                            </div>
                        </div>
                        <div class="quantity-control">
                            <button class="quantity-btn minus-btn" type="button">-</button>
                            <span class="quantity-display">0</span>
                            <button class="quantity-btn plus-btn" type="button">+</button>
                        </div>
                    </div>
                    <div class="product-item" data-product-id="5" data-price="450" data-name="Prework out Zen">
                        <div class="product-info">
                            <div class="product-icon">⚡️</div>
                            <div class="product-details">
                                <div class="product-title">Prework out Zen</div>
                                <div class="product-price">$450 MXN</div>
                            </div>
                        </div>
                        <div class="quantity-control">
                            <button class="quantity-btn minus-btn" type="button">-</button>
                            <span class="quantity-display">0</span>
                            <button class="quantity-btn plus-btn" type="button">+</button>
                        </div>
                    </div>
                    <div class="product-item" data-product-id="6" data-price="400" data-name="Cafeína anhidra 100 caps">
                        <div class="product-info">
                            <div class="product-icon">☕</div>
                            <div class="product-details">
                                <div class="product-title">Cafeína anhidra 100 caps</div>
                                <div class="product-price">$400 MXN</div>
                            </div>
                        </div>
                        <div class="quantity-control">
                            <button class="quantity-btn minus-btn" type="button">-</button>
                            <span class="quantity-display">0</span>
                            <button class="quantity-btn plus-btn" type="button">+</button>
                        </div>
                    </div>
                    <div class="product-item" data-product-id="7" data-price="410" data-name="Creatina Deluxe 100 caps">
                        <div class="product-info">
                            <div class="product-icon">💊</div>
                            <div class="product-details">
                                <div class="product-title">Creatina Deluxe 100 caps</div>
                                <div class="product-price">$410 MXN</div>
                            </div>
                        </div>
                        <div class="quantity-control">
                            <button class="quantity-btn minus-btn" type="button">-</button>
                            <span class="quantity-display">0</span>
                            <button class="quantity-btn plus-btn" type="button">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="summary-section">
                <div class="summary-container">
                    <h3 class="summary-title">Resumen de tu Pedido</h3>
                    <div id="selected-products-list">
                        <!-- Selected products will be dynamically added here -->
                    </div>
                     <div id="shipping-cost" class="summary-item hidden">
                        <span>Costo de Envío:</span>
                        <span id="costo-envio">--</span>
                    </div>
                    <div id="summary-total" class="summary-total">Total: $0 MXN</div>
                </div>
            </div>

            <!-- Buttons moved to the bottom and styled as a row -->
            <div class="flex flex-col sm:flex-row justify-center items-center mt-4 space-y-2 sm:space-y-0 sm:space-x-2">
                <button class="btn" id="back-patrocinio-btn" type="button">Regresar</button>
                <button class="btn bg-green-600 hover:bg-green-700 border-green-600 hover:border-green-700" id="send-btn">
                    Enviar a WhatsApp
                </button>
            </div>
        </form>
    </div>

    <!-- Custom Message Box -->
    <div id="message-box" class="message-box"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mainContainer = document.getElementById('main-container');
            const cipherTextElem = document.getElementById('cipher-text');
            const optionsTextElem = document.getElementById('options-text');
            const leapTextElem = document.getElementById('leap-text');
            const buttonsContainer = document.getElementById('buttons-container');
            
            const patrocinioBtn = document.getElementById('patrocinio-btn');
            const tiendaBtn = document.getElementById('tienda-btn');
            const patrocinioContainer = document.getElementById('patrocinio-container');
            const formTitle = document.getElementById('form-title');
            const patrocinioForm = document.getElementById('patrocinio-form');
            const costoEnvioElem = document.getElementById('costo-envio');
            const estadoInput = document.getElementById('estado');
            const datalistEstados = document.getElementById('estados-mexico');
            const backPatrocinioBtn = document.getElementById('back-patrocinio-btn');
            const messageBox = document.getElementById('message-box');
            const shippingCostContainer = document.getElementById('shipping-cost');
            const sendBtn = document.getElementById('send-btn');
            const productsSection = document.getElementById('products-section');
            const summarySection = document.getElementById('summary-section');
            const productListContainer = document.querySelector('.product-list');
            const selectedProductsList = document.getElementById('selected-products-list');
            const summaryTotalElem = document.getElementById('summary-total');

            const fullText = "Bienvenido a Power Labz";
            const optionsText = "selecciona las opciones";
            const leapText = "un pequeño gran salto";

            let selectedProducts = {};
            let isStoreMode = false;
            
            // Mapa con los costos de envío para estados específicos (rango de $290 a $430 pesos).
            const shippingCosts = new Map([
                ["Ciudad de México", 290],
                ["Estado de México", 290],
                ["Hidalgo", 290],
                ["Puebla", 310],
                ["Veracruz", 350],
                ["Jalisco", 350],
                ["Nuevo León", 400],
                ["Chihuahua", 430],
                ["Baja California", 430],
                ["Coahuila", 350]
            ]);
            const defaultCost = 350;

            // Mapeo de nombres largos a nombres cortos para el cálculo de costos.
            const stateNameMapping = new Map([
                ["Coahuila de Zaragoza", "Coahuila"],
                ["Ciudad de México (CDMX)", "Ciudad de México"],
                ["México (Estado de México)", "Estado de México"],
                ["Veracruz de Ignacio de la Llave", "Veracruz"],
            ]);

            // Lista completa de estados de México proporcionada por el usuario
            const estadosDeMexico = [
                "Aguascalientes", "Baja California", "Baja California Sur", "Campeche", "Chiapas", "Chihuahua", "Ciudad de México (CDMX)", "Coahuila de Zaragoza", "Colima", "Durango", "Guanajuato", "Guerrero", "Hidalgo", "Jalisco", "México (Estado de México)", "Michoacán de Ocampo", "Morelos", "Nayarit", "Nuevo León", "Oaxaca", "Puebla", "Querétaro", "Quintana Roo", "San Luis Potosí", "Sinaloa", "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala", "Veracruz de Ignacio de la Llave", "Yucatán", "Zacatecas"
            ];
            
            // Popula el datalist con todos los estados
            estadosDeMexico.forEach(estado => {
                const option = document.createElement('option');
                option.value = estado;
                datalistEstados.appendChild(option);
            });

            const scramble = (text) => {
                return text.split('').map(() => String.fromCharCode(33 + Math.floor(Math.random() * 94))).join('');
            };

            const decrypt = (element, text, duration, delay) => {
                return new Promise(resolve => {
                    let startTime = null;
                    const scrambleInterval = 50;

                    const animate = (timestamp) => {
                        if (!startTime) startTime = timestamp;
                        const elapsed = timestamp - startTime;
                        const progress = Math.min(1, elapsed / duration);
                        const charsToShow = Math.floor(progress * text.length);

                        const decryptedPart = text.substring(0, charsToShow);
                        const scrambledPart = scramble(text.substring(charsToShow));

                        element.textContent = decryptedPart + scrambledPart;

                        if (progress < 1) {
                            setTimeout(() => requestAnimationFrame(animate), scrambleInterval);
                        } else {
                            element.textContent = text;
                            resolve();
                        }
                    };

                    setTimeout(() => requestAnimationFrame(animate), delay);
                });
            };

            const startDecryptionSequence = async () => {
                await decrypt(cipherTextElem, fullText, 1000, 500);
                
                setTimeout(() => {
                    optionsTextElem.textContent = optionsText;
                    optionsTextElem.style.opacity = '1';
                }, 1000);

                setTimeout(() => {
                    leapTextElem.textContent = leapText;
                    leapTextElem.style.opacity = '1';
                }, 1700);

                setTimeout(() => {
                    buttonsContainer.classList.remove('hidden');
                }, 2400);
            };

            const showMessageBox = (message) => {
                messageBox.textContent = message;
                messageBox.style.opacity = '1';
                setTimeout(() => {
                    messageBox.style.opacity = '0';
                }, 3000);
            };

            const transitionToSection = (targetSection, isPatrocinio) => {
                const currentActive = document.querySelector('.active-section');
                if (currentActive) {
                    currentActive.classList.remove('active-section');
                }
                targetSection.classList.add('active-section');

                if (isPatrocinio) {
                    formTitle.textContent = "Formulario de Patrocinio";
                    // Now, the product and summary sections are always visible, so we don't need to hide them
                    isStoreMode = false;
                    resetProductSelection();
                } else {
                    formTitle.textContent = "Formulario de Envío y Productos";
                    isStoreMode = true;
                }
            };
            
            patrocinioBtn.addEventListener('click', () => {
                transitionToSection(patrocinioContainer, true);
            });

            tiendaBtn.addEventListener('click', () => {
                transitionToSection(patrocinioContainer, false);
            });

            backPatrocinioBtn.addEventListener('click', () => {
                transitionToSection(mainContainer);
                shippingCostContainer.classList.add('hidden');
                costoEnvioElem.textContent = '--';
            });
            
            const calculateShippingCost = (estado) => {
                const mappedEstado = stateNameMapping.get(estado) || estado;
                const cost = shippingCosts.get(mappedEstado) || defaultCost;
                return cost;
            };

            const saveFormData = () => {
                const formData = {
                    nombre: document.getElementById('nombre').value,
                    celular: document.getElementById('celular').value,
                    email: document.getElementById('email').value,
                    direccion: document.getElementById('direccion').value,
                    colonia: document.getElementById('colonia').value,
                    ciudad: document.getElementById('ciudad').value,
                    estado: document.getElementById('estado').value,
                    cp: document.getElementById('cp').value,
                    referencia: document.getElementById('referencia').value,
                };
                localStorage.setItem('patrocinioFormData', JSON.stringify(formData));
            };

            const loadFormData = () => {
                const savedData = localStorage.getItem('patrocinioFormData');
                if (savedData) {
                    const formData = JSON.parse(savedData);
                    document.getElementById('nombre').value = formData.nombre || '';
                    document.getElementById('celular').value = formData.celular || '';
                    document.getElementById('email').value = formData.email || '';
                    document.getElementById('direccion').value = formData.direccion || '';
                    document.getElementById('colonia').value = formData.colonia || '';
                    document.getElementById('ciudad').value = formData.ciudad || '';
                    document.getElementById('estado').value = formData.estado || '';
                    document.getElementById('cp').value = formData.cp || '';
                    document.getElementById('referencia').value = formData.referencia || '';

                    if (formData.estado) {
                         const shippingCost = calculateShippingCost(formData.estado);
                         const costText = `$${shippingCost} MXN`;
                         shippingCostContainer.classList.remove('hidden');
                         costoEnvioElem.textContent = costText;
                    }
                }
            };

            estadoInput.addEventListener('input', async (e) => {
                updateSummary();
            });

            patrocinioForm.addEventListener('input', saveFormData);

            // Se cambia el evento de submit del formulario a un evento de clic en el botón
            // para evitar el comportamiento por defecto de submit del formulario
            sendBtn.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Validar que todos los campos requeridos estén llenos
                if (!patrocinioForm.reportValidity()) {
                    return;
                }
                
                // Validación específica para la tienda: debe haber al menos un producto seleccionado
                if (isStoreMode && Object.keys(selectedProducts).length === 0) {
                     showMessageBox('Por favor, selecciona al menos un producto.');
                     return;
                }

                const selectedState = estadoInput.value;
                const isBuyingProducts = Object.keys(selectedProducts).length > 0;
                
                if (isBuyingProducts && !estadosDeMexico.includes(selectedState)) {
                    showMessageBox('Por favor, selecciona un estado válido de la lista para calcular el envío.');
                    return;
                }
                
                let message = "Hola, me gustaría realizar un pedido con la siguiente información:\n\n";
                
                if (isStoreMode) {
                    message += "--- Pedido de productos ---\n";
                } else {
                    message += "--- Solicitud de patrocinio ---\n";
                }
                
                if (isBuyingProducts) {
                    message += "Productos:\n";
                    let totalProductos = 0;
                    for (const id in selectedProducts) {
                        const item = selectedProducts[id];
                        message += `* ${item.quantity}x ${item.name} ($${item.price} c/u)\n`;
                        totalProductos += item.quantity * item.price;
                    }
                    message += `Total de productos: $${totalProductos} MXN\n\n`;

                    const shippingCost = calculateShippingCost(selectedState);
                    const totalPagar = totalProductos + shippingCost;
                    message += `Costo de Envío: $${shippingCost} MXN\n\n`;
                    message += `TOTAL A PAGAR: $${totalPagar} MXN\n\n`;
                } else {
                    message += "Productos:\nSin productos seleccionados\n\n";
                    // Asegúrate de que el costo de envío se muestre y se sume incluso sin productos
                    if (estadosDeMexico.includes(selectedState)) {
                        const shippingCost = calculateShippingCost(selectedState);
                        message += `Costo de Envío: $${shippingCost} MXN\n\n`;
                        message += `TOTAL A PAGAR: $${shippingCost} MXN\n\n`;
                    }
                }

                message += "--- Información de Contacto y Envío ---\n";
                message += `Nombre: ${document.getElementById('nombre').value}\n`;
                message += `Celular: ${document.getElementById('celular').value}\n`;
                message += `Email: ${document.getElementById('email').value}\n`;
                message += `Dirección: ${document.getElementById('direccion').value}, Colonia: ${document.getElementById('colonia').value}\n`;
                message += `Ciudad: ${document.getElementById('ciudad').value}, Estado: ${document.getElementById('estado').value}, C.P.: ${document.getElementById('cp').value}\n`;
                message += `Referencia: ${document.getElementById('referencia').value}\n`;
                
                const phoneNumber = '5572365913';
                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                
                window.open(whatsappUrl, '_blank');
                showMessageBox('Abriendo WhatsApp...');
                patrocinioForm.reset();
                selectedProducts = {};
                updateSummary();
                shippingCostContainer.classList.add('hidden');
                costoEnvioElem.textContent = '--';
                transitionToSection(mainContainer);
                localStorage.removeItem('patrocinioFormData');
            });

            const resetProductSelection = () => {
                selectedProducts = {};
                document.querySelectorAll('.product-item').forEach(item => {
                    item.classList.remove('selected');
                    item.querySelector('.quantity-display').textContent = 0;
                });
                updateSummary();
            };

            const updateSummary = () => {
                selectedProductsList.innerHTML = '';
                let productsTotal = 0;
                
                // Muestra la lista de productos seleccionados y calcula el subtotal de productos
                for (const id in selectedProducts) {
                    const item = selectedProducts[id];
                    if (item.quantity > 0) {
                        const itemTotal = item.quantity * item.price;
                        productsTotal += itemTotal;

                        const summaryItem = document.createElement('div');
                        summaryItem.className = 'summary-item';
                        summaryItem.innerHTML = `
                            <span>${item.name} (${item.quantity})</span>
                            <span>$${itemTotal} MXN</span>
                        `;
                        selectedProductsList.appendChild(summaryItem);
                    }
                }
                
                let finalTotal = productsTotal;
                const estado = estadoInput.value;
                const isStateValid = estadosDeMexico.includes(estado);

                // Muestra el costo de envío si el estado es válido
                if (isStateValid) {
                    const shippingCost = calculateShippingCost(estado);
                    shippingCostContainer.classList.remove('hidden');
                    costoEnvioElem.textContent = `$${shippingCost} MXN`;
                    
                    // Suma el costo de envío al total, sin importar si hay productos
                    finalTotal += shippingCost;
                } else {
                    shippingCostContainer.classList.add('hidden');
                }
                
                summaryTotalElem.textContent = `Total: $${finalTotal} MXN`;
            };
            
            // Event listener for clicking on the product item itself to select/deselect
            productListContainer.addEventListener('click', (e) => {
                const productItem = e.target.closest('.product-item');
                const isQuantityBtn = e.target.closest('.quantity-btn') || e.target.closest('.remove-btn');

                if (productItem && !isQuantityBtn) {
                    const productId = productItem.dataset.productId;
                    const productName = productItem.dataset.name;
                    const productPrice = parseInt(productItem.dataset.price);
                    const quantityDisplay = productItem.querySelector('.quantity-display');

                    if (!productItem.classList.contains('selected')) {
                        // Select the product
                        quantityDisplay.textContent = 1;
                        productItem.classList.add('selected');
                        selectedProducts[productId] = {
                            name: productName,
                            price: productPrice,
                            quantity: 1
                        };
                        showMessageBox(`Se seleccionó ${productName}`);
                    } else {
                        // Deselect the product
                        quantityDisplay.textContent = 0;
                        productItem.classList.remove('selected');
                        delete selectedProducts[productId];
                        showMessageBox('Producto eliminado de la selección.');
                    }
                    updateSummary();
                }

                // Event listener for quantity buttons
                if (e.target.closest('.plus-btn')) {
                    const productItem = e.target.closest('.product-item');
                    const productId = productItem.dataset.productId;
                    const productName = productItem.dataset.name;
                    const productPrice = parseInt(productItem.dataset.price);
                    const quantityDisplay = productItem.querySelector('.quantity-display');

                    let quantity = parseInt(quantityDisplay.textContent, 10);
                    quantity++;
                    quantityDisplay.textContent = quantity;
                    productItem.classList.add('selected');

                    selectedProducts[productId] = {
                        name: productName,
                        price: productPrice,
                        quantity: quantity
                    };

                    updateSummary();

                } else if (e.target.closest('.minus-btn')) {
                    const productItem = e.target.closest('.product-item');
                    const productId = productItem.dataset.productId;
                    const quantityDisplay = productItem.querySelector('.quantity-display');

                    let quantity = parseInt(quantityDisplay.textContent, 10);
                    if (quantity > 0) {
                        quantity--;
                        quantityDisplay.textContent = quantity;
                        
                        if (quantity === 0) {
                            productItem.classList.remove('selected');
                            delete selectedProducts[productId];
                            showMessageBox('Producto eliminado de la selección.');
                        } else {
                            selectedProducts[productId].quantity = quantity;
                        }

                        updateSummary();
                    }
                } else if (e.target.closest('.remove-btn')) {
                    const productItem = e.target.closest('.product-item');
                    const productId = productItem.dataset.productId;
                    const productName = productItem.dataset.name;
                    const quantityDisplay = productItem.querySelector('.quantity-display');
                    
                    quantityDisplay.textContent = 0;
                    productItem.classList.remove('selected');
                    delete selectedProducts[productId];
                    updateSummary();
                    showMessageBox(`Se eliminó "${productName}" del pedido.`);
                }
            });
            
            // Start the initial animation and load data
            startDecryptionSequence();
            loadFormData();
        });
    </script>
</body>
</html>
